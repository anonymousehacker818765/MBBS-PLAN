<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MBBS Tracker</title>

<style>
:root{
  --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --muted:#94a3b8;
  --border:#334155; --nav:80px;
  --anat:#f43f5e; --phy:#22c55e; --bio:#eab308; --primary:#3b82f6;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui;
  background:var(--bg); color:var(--text);
  padding-bottom:calc(var(--nav) + 20px);
}

/* Header */
.header{
  position:sticky; top:0; z-index:100;
  background:rgba(15,23,42,.96);
  border-bottom:1px solid var(--border);
}
.title{padding:16px 20px 6px; margin:0; font-size:1.4rem; font-weight:800}
.tabs{display:flex; gap:10px; padding:10px 20px 12px; overflow-x:auto}
.tab-btn{
  padding:8px 16px; border-radius:20px;
  border:1px solid var(--border);
  background:var(--card); color:var(--muted);
  font-weight:600; cursor:pointer;
}
.tab-btn.active{background:#fff; color:#000}
.tab-btn[data-sub="Anatomy"].active{background:var(--anat)}
.tab-btn[data-sub="Physiology"].active{background:var(--phy)}
.tab-btn[data-sub="Biochemistry"].active{background:var(--bio)}

.container{padding:22px}
.view{display:none}
.view.active{display:block}

/* Feed */
.date-divider{
  margin:32px 0 14px; display:flex; gap:12px; align-items:center;
  font-size:.8rem; font-weight:800; color:var(--muted);
}
.date-divider::after{content:''; flex:1; height:1px; background:var(--border)}
.date-divider.highlight{
  background:rgba(59,130,246,.15);
  padding:6px 10px; border-radius:6px;
}

.task{
  display:flex; background:var(--card);
  border:1px solid var(--border);
  border-radius:16px; margin-bottom:14px; overflow:hidden;
}
.strip{width:5px}
.task[data-sub="Anatomy"] .strip{background:var(--anat)}
.task[data-sub="Physiology"] .strip{background:var(--phy)}
.task[data-sub="Biochemistry"] .strip{background:var(--bio)}

.task-body{flex:1; padding:14px 16px}
.badge{
  font-size:.65rem; font-weight:800; text-transform:uppercase;
  padding:3px 6px; border-radius:4px; display:inline-block;
}
.task[data-sub="Anatomy"] .badge{color:var(--anat); background:rgba(244,63,94,.2)}
.task[data-sub="Physiology"] .badge{color:var(--phy); background:rgba(34,197,94,.2)}
.task[data-sub="Biochemistry"] .badge{color:var(--bio); background:rgba(234,179,8,.2)}

.task-title{margin-top:6px; font-size:1rem; font-weight:600; line-height:1.5}

.task-action{padding:0 16px; display:flex; align-items:center}
.check{
  width:28px; height:28px; border-radius:50%;
  border:2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.task.done{opacity:.5}
.task.done .check{background:var(--phy); border-color:var(--phy); color:#000}

/* Calendar */
.cal-header{
  display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;
}
.cal-btn{
  background:var(--card); border:1px solid var(--border);
  color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer;
}
.cal-title{font-weight:800}
.weekdays{
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:6px; opacity:.6; font-size:.8rem; margin-bottom:6px;
}
.weekdays div{text-align:center}
.cal-grid{
  display:grid; grid-template-columns:repeat(7,1fr); gap:6px;
}
.cal-day{
  aspect-ratio:1; background:var(--card); border-radius:10px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; position:relative;
}
.cal-day.inactive{opacity:.35}
.cal-day.today{border:2px solid var(--primary); color:var(--primary); font-weight:800}
.cal-dots{display:flex; gap:4px; margin-top:4px}
.dot{width:6px; height:6px; border-radius:50%}
.red{background:var(--anat)}
.green{background:var(--phy)}

/* Progress */
.progress-card{
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; padding:16px; margin-bottom:14px;
}
.progress-row{display:flex; justify-content:space-between; margin:6px 0; color:var(--muted)}

/* Nav */
.nav{
  position:fixed; bottom:0; left:0; right:0;
  height:var(--nav); background:rgba(15,23,42,.96);
  border-top:1px solid var(--border); display:flex;
}
.nav-btn{
  flex:1; border:none; background:none; color:var(--muted);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  font-weight:600; cursor:pointer;
}
.nav-btn.active{color:var(--text)}
.nav-icon{font-size:1.4rem; margin-bottom:4px}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  z-index:500;
  text-align:center;
">
  <h1 style="font-size:2rem; margin-bottom:8px;">MBBS Tracker</h1>
  <p style="color:var(--muted); margin-bottom:20px;">
    Plan â€¢ Track â€¢ Complete
  </p>
  <button id="loginBtn" class="tab-btn" style="padding:12px 24px;">
    Continue with Google
  </button>
</div>



<div id="app" style="display:none;">

  

<div class="header">
  <h1 class="title" id="pageTitle">My Feed</h1>


  <div style="padding:0 20px 10px; display:flex; justify-content:flex-end;">
  <img
    id="profileAvatar"
    src=""
    alt="Profile"
    style="
      width:36px;
      height:36px;
      border-radius:50%;
      cursor:pointer;
      display:none;
      object-fit:cover;
    "
  />
</div>


  <!-- Feed-only filters -->
  <div id="feedFilters">
    <div class="tabs">
      <button class="tab-btn active" onclick="setSubject('All',this)">All</button>
      <button class="tab-btn" data-sub="Anatomy" onclick="setSubject('Anatomy',this)">Anatomy</button>
      <button class="tab-btn" data-sub="Physiology" onclick="setSubject('Physiology',this)">Physiology</button>
      <button class="tab-btn" data-sub="Biochemistry" onclick="setSubject('Biochemistry',this)">Biochemistry</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="setStatus('All',this)">All</button>
      <button class="tab-btn" onclick="setStatus('Done',this)">Completed</button>
      <button class="tab-btn" onclick="setStatus('Pending',this)">Pending</button>
    </div>
  </div>
</div>

<div id="feedView" class="view active">
  <div class="container" id="feed"></div>
</div>

<div id="calendarView" class="view">
  <div class="container">
    <div class="cal-header">
      <button class="cal-btn" onclick="changeMonth(-1)">â—€</button>
      <div class="cal-title" id="calTitle"></div>
      <button class="cal-btn" onclick="changeMonth(1)">â–¶</button>
    </div>
    <div class="weekdays">
      <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
    </div>
    <div class="cal-grid" id="calendar"></div>
  </div>
</div>

<div id="progressView" class="view">
  <div class="container" id="progress"></div>
</div>

<div class="nav">
  <button class="nav-btn active" onclick="showView('feed',this)">
    <div class="nav-icon">âš¡</div>Timeline
  </button>
  <button class="nav-btn" onclick="showView('calendar',this)">
    <div class="nav-icon">ðŸ“…</div>Calendar
  </button>
  <button class="nav-btn" onclick="showView('progress',this)">
    <div class="nav-icon">ðŸ“Š</div>Progress
  </button>
</div>



<!-- Sidebar -->
<div id="sidebarOverlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  z-index:300;
"></div>

<div id="sidebar" style="
  position:fixed;
  top:0;
  right:-280px;
  width:280px;
  height:100%;
  background:var(--card);
  border-left:1px solid var(--border);
  padding:20px;
  z-index:301;
  transition:right 0.25s ease;
">

  <div style="text-align:center;">
    <img id="sidebarAvatar" style="
      width:72px;
      height:72px;
      border-radius:50%;
      object-fit:cover;
      margin-bottom:10px;
    "/>

    <div id="sidebarName" style="font-weight:700;"></div>
    <div id="sidebarEmail" style="font-size:0.8rem; color:var(--muted);"></div>
  </div>

  <hr style="margin:20px 0; border-color:var(--border);" />

  <button id="sidebarLogout" class="tab-btn" style="width:100%;">
    Logout
  </button>
</div>


  


<!-- Firebase SDKs (COMPAT) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA8m3dMtEJXZc8DYkVXpDZ3IOoLEIJLJlM",
    authDomain: "mbbs-tracker-c6a28.firebaseapp.com",
    projectId: "mbbs-tracker-c6a28",
    storageBucket: "mbbs-tracker-c6a28.appspot.com",
    messagingSenderId: "725685358961",
    appId: "1:725685358961:web:c1103c31f8604930c326d0"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

</script>


<script>
  // Google Auth provider
  const provider = new firebase.auth.GoogleAuthProvider();

  // Login button
  const loginBtn = document.getElementById('loginBtn');

  loginBtn.onclick = () => {
    auth.signInWithPopup(provider).catch(err => {
      alert(err.message);
    });
  };
</script>

  
  

<script>
/* =========================
   CONFIG
========================= */
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREP7TsehrrFKgBrYNgyJyEc_56SWhnuXWydOyDIvjKGVwC6USsHzNdC13AlojDBuSmvi1D2H9HEudp/pub?output=csv";

/* =========================
   STATE
========================= */
let allData = [];
let subjectFilter = 'All';
let statusFilter = 'All';
let currentMonth = new Date(); // shared between calendar & monthly progress
let jumpDate = null;
// ðŸ”¥ Firestore user state
let currentUser = null;
let completedTasks = new Set();
/* =========================
   HELPERS
========================= */
const clean = s => s?.replace(/^"|"$/g,'').trim() || '';
const pad = n => String(n).padStart(2,'0');
const toKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const displayDate = key => {
  const [y,m,d] = key.split('-');
  return `${d}/${m}/${y}`; // DD/MM/YYYY
};
const monthTitle = d => d.toLocaleDateString('en-GB',{month:'long', year:'numeric'});

/* =========================
   INIT
========================= */
fetch(SHEET_URL).then(r=>r.text()).then(text=>{
  allData = text.split('\n').slice(1).map((row,i)=>{
    if(!row.trim()) return null;
    const c = row.split(',');
    if(c.length < 4) return null;
    return {
      id: clean(c[0]),
      date: clean(c[1]),       // YYYY-MM-DD
      subject: clean(c[2]),
      topic: clean(c.slice(3).join(',')),
      order: i
    };
  }).filter(Boolean);

  renderFeed();
  renderCalendar();
  renderProgress();
});

/* =========================
   FEED
========================= */
function renderFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  let data = [...allData];
  if(subjectFilter !== 'All') data = data.filter(t=>t.subject === subjectFilter);
  if(statusFilter === 'Done') data = data.filter(t=>completedTasks.has(t.id));
  if(statusFilter === 'Pending') data = data.filter(t=>!completedTasks.has(t.id));

  data.sort((a,b)=>a.date.localeCompare(b.date) || a.order-b.order);

  let lastKey = '';
  data.forEach(t=>{
    if(t.date !== lastKey){
      const h = document.createElement('div');
      h.className = 'date-divider';
      h.id = 'd-' + t.date;
      h.textContent = displayDate(t.date);
      feed.appendChild(h);
      lastKey = t.date;
    }

    const task = document.createElement('div');
    task.className = 'task' + (completedTasks.has(t.id)?' done':'');
    task.dataset.sub = t.subject;

    const strip = document.createElement('div');
    strip.className = 'strip';

    const body = document.createElement('div');
    body.className = 'task-body';

    const badge = document.createElement('span');
    badge.className = 'badge';
    badge.textContent = t.subject;

    const title = document.createElement('div');
    title.className = 'task-title';
    
    if (t.topic.includes('|')) {
      const parts = t.topic.split('|').map(p => p.trim()).filter(Boolean);
    
      // First part as heading
      const head = document.createElement('div');
      head.style.fontWeight = '700';
      head.style.marginBottom = '6px';
      head.textContent = parts[0];
    
      // Remaining parts as bullet list
      const ul = document.createElement('ul');
      ul.style.margin = '6px 0 0 18px';
      ul.style.padding = '0';
      ul.style.lineHeight = '1.5';
    
      parts.slice(1).forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
    
      title.appendChild(head);
      title.appendChild(ul);
    } else {
      title.textContent = t.topic;
    }
    
    body.append(badge, title);

    const act = document.createElement('div');
    act.className = 'task-action';

    const chk = document.createElement('div');
    chk.className = 'check';
    chk.textContent = completedTasks.has(t.id)?'âœ“':'';
    chk.onclick = async () => {
      if (!currentUser) return;
    
      const ref = db
        .collection('users')
        .doc(currentUser.uid)
        .collection('completions')
        .doc(t.id);
    
      if (completedTasks.has(t.id)) {
        await ref.delete();
        completedTasks.delete(t.id);
      } else {
        await ref.set({ done: true });
        completedTasks.add(t.id);
      }
    
      renderFeed();
      renderCalendar();
      renderProgress();
    };

    act.appendChild(chk);
    task.append(strip, body, act);
    feed.appendChild(task);
  });

  if(jumpDate){
    const el = document.getElementById('d-' + jumpDate);
    if(el){
      el.scrollIntoView({behavior:'smooth', block:'start'});
      el.classList.add('highlight');
      setTimeout(()=>el.classList.remove('highlight'),700);
    }
    jumpDate = null;
  }
}

/* =========================
   CALENDAR (FULL MONTH)
========================= */
function renderCalendar(){
  const cal = document.getElementById('calendar');
  const title = document.getElementById('calTitle');
  cal.innerHTML = '';
  title.textContent = monthTitle(currentMonth);

  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  // Leading blanks
  for(let i=0;i<firstDay;i++){
    const blank = document.createElement('div');
    blank.className = 'cal-day inactive';
    cal.appendChild(blank);
  }

  const todayKey = toKey(new Date());

  for(let d=1; d<=daysInMonth; d++){
    const key = `${year}-${pad(month+1)}-${pad(d)}`;
    const cell = document.createElement('div');
    cell.className = 'cal-day';
    if(key === todayKey) cell.classList.add('today');
    cell.textContent = d;

    // dot logic (truthful, filter-independent)
    const dayTasks = allData.filter(t=>t.date === key);
    if(dayTasks.length){
      const allDone = dayTasks.every(t=>completedTasks.has(t.id));
      const dots = document.createElement('div');
      dots.className = 'cal-dots';
      const dot = document.createElement('div');
      dot.className = 'dot ' + (allDone ? 'green' : 'red');
      dots.appendChild(dot);
      cell.appendChild(dots);

      cell.onclick = ()=>{
        jumpDate = key;
        showView('feed', document.querySelector('.nav-btn'));
      };
    }else{
      cell.onclick = ()=>{}; // no-op
    }

    cal.appendChild(cell);
  }
}

function changeMonth(delta){
  currentMonth.setMonth(currentMonth.getMonth() + delta);
  renderCalendar();
  renderProgress(); // shared month state
}

/* =========================
   PROGRESS
========================= */
function renderProgress(){
  const p = document.getElementById('progress');
  p.innerHTML = '';

  // All-time
  const total = allData.length;
  const done = allData.filter(t=>completedTasks.has(t.id)).length;

  const allCard = document.createElement('div');
  allCard.className = 'progress-card';
  allCard.innerHTML = `
    <strong>All-time</strong>
    <div class="progress-row"><span>Total</span><span>${total}</span></div>
    <div class="progress-row"><span>Completed</span><span>${done}</span></div>
    <div class="progress-row"><span>Pending</span><span>${total-done}</span></div>
  `;
  p.appendChild(allCard);

  // Subject-wise
  ['Anatomy','Physiology','Biochemistry'].forEach(s=>{
    const t = allData.filter(x=>x.subject===s);
    const d = t.filter(x=>completedTasks.has(x.id)).length;
    const c = document.createElement('div');
    c.className = 'progress-card';
    c.innerHTML = `
      <strong>${s}</strong>
      <div class="progress-row"><span>Completed</span><span>${d} / ${t.length}</span></div>
    `;
    p.appendChild(c);
  });

  // Monthly (shared with calendar month)
  const y = currentMonth.getFullYear();
  const m = currentMonth.getMonth()+1;
  const monthTasks = allData.filter(t=>{
    const [yy,mm] = t.date.split('-').map(Number);
    return yy===y && mm===m;
  });
  const mdone = monthTasks.filter(t=>completedTasks.has(t.id)).length;

  const mcard = document.createElement('div');
  mcard.className = 'progress-card';
  mcard.innerHTML = `
    <strong>${monthTitle(currentMonth)} (Monthly)</strong>
    <div class="progress-row"><span>Total</span><span>${monthTasks.length}</span></div>
    <div class="progress-row"><span>Completed</span><span>${mdone}</span></div>
    <div class="progress-row"><span>Pending</span><span>${monthTasks.length-mdone}</span></div>
  `;
  p.appendChild(mcard);
}

/* =========================
   FILTERS (FEED ONLY)
========================= */
function setSubject(s, btn){
  subjectFilter = s;
  document.querySelectorAll('#feedFilters .tabs:first-child .tab-btn')
    .forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderFeed();
}
function setStatus(s, btn){
  statusFilter = s;
  document.querySelectorAll('#feedFilters .tabs:last-child .tab-btn')
    .forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderFeed();
}

/* =========================
   NAV
========================= */
function showView(view, btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(view+'View').classList.add('active');

  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  btn && btn.classList.add('active');

  document.getElementById('feedFilters').style.display = view==='feed'?'block':'none';
  document.getElementById('pageTitle').textContent =
    view==='feed'?'My Feed':view==='calendar'?'Calendar':'Progress';

  if(view==='progress') renderProgress();
}




/* =========================
   SIDEBAR + AVATAR LOGIC
========================= */

const avatar = document.getElementById('profileAvatar');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');
const sidebarAvatar = document.getElementById('sidebarAvatar');
const sidebarName = document.getElementById('sidebarName');
const sidebarEmail = document.getElementById('sidebarEmail');
const sidebarLogout = document.getElementById('sidebarLogout');

avatar.onclick = () => {
  sidebar.style.right = '0';
  overlay.style.display = 'block';
};

overlay.onclick = () => {
  sidebar.style.right = '-280px';
  overlay.style.display = 'none';
};

sidebarLogout.onclick = () => {
  auth.signOut();
  sidebar.style.right = '-280px';
  overlay.style.display = 'none';
};
  


/* =========================
   AUTH STATE HANDLER
========================= */

auth.onAuthStateChanged(async user => {
  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');

  if (user) {
    currentUser = user;

    // UI
    loginScreen.style.display = 'none';
    app.style.display = 'block';

    avatar.src = user.photoURL || '';
    avatar.style.display = 'block';

    sidebarAvatar.src = user.photoURL || '';
    sidebarName.textContent = user.displayName || 'User';
    sidebarEmail.textContent = user.email || '';

    const firstName = user.displayName?.split(' ')[0] || 'Student';
    pageTitle.textContent = `Hello, ${firstName}`;

    // ðŸ”¥ FIRESTORE READ (NEW)
    completedTasks.clear();

    const snap = await db
      .collection('users')
      .doc(user.uid)
      .collection('completions')
      .get();

    snap.forEach(doc => completedTasks.add(doc.id));

    // Refresh UI
    renderFeed();
    renderCalendar();
    renderProgress();

  } else {
    currentUser = null;
    completedTasks.clear();

    app.style.display = 'none';
    loginScreen.style.display = 'flex';

    avatar.style.display = 'none';
    pageTitle.textContent = 'My Feed';
  }
});

</script>  
</div>
</body>
</html>
